% vi: noexpandtab:tabstop=4:ft=gprolog
% Copyright (c) 2023 Sergey Sikorskiy, released under the GNU GPLv2 license.

% Installing Void on a ZFS Root - https://docs.voidlinux.org/installation/guides/zfs.html
% https://openzfs.github.io/openzfs-docs/man/master/8/zpool.8.html#ENVIRONMENT_VARIABLES

uses_zfs(TL) :-
	memberchk(fs5_multi(zfs, _Label, _DL, _PTL, _CK), TL),
	true.

% Do not mount the newly created file system.
zfs_pool_cmd(MP, _DS, _AL, [zfs, create, '-u', o(o, mountpoint=MP)]).
zfs_pool_cmd(_MP, _DS, AL, OL) :-
	findall(o(o, A), member(A, AL), OL).
zfs_pool_cmd(_MP, DS, _AL, [concat(zroot, DS)]).

mkfs_multi_zfs(PTL) :-
	forall(member(dataset(DS, MP, AL), PTL), (findall(C, (zfs_pool_cmd(MP, DS, AL, CL), member(C, CL)), CMD), os_shell2(CMD))),
	true.

install_zfs(TL, _RD) :-
	uses_zfs(TL),
	% os_call2([zgenhostid, '-f']), % Void won't boot with hostid generated by zgenhostid.
	lx_gen_hostid(''),
	!.
install_zfs(_TL, _).

zfs_passphrase(PASS) :-
	FN = '/etc/zfs/zroot.key',
	open(FN, write, S),
	write(S, PASS),
	close(S),
	os_call2([chmod, '000', FN]),
	true.

zpool_destroy_all :-
	zpool_list(L),
	member(zp(PN,_A2,_A3,_A4,_A5,_A6,_A7,_A8,_A9,_A10,_A11), L),
	% tui_progressbox_safe([zpool, export, '-f', PN, '2>&1'], '', [title(' exporting zpool '), sz([6, 40])]),
	tui_progressbox_safe([zpool, destroy, '-f', PN, '2>&1'], '', [title(' destroying zpool '), sz([6, 40])]),
	fail.
zpool_destroy_all.

